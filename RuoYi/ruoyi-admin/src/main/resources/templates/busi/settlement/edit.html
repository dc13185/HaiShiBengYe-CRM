<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
    <th:block th:include="include :: header('修改业务费用结算')" />
</head>
<body class="white-bg">
    <div class="wrapper wrapper-content animated fadeInRight ibox-content">
        <form class="form-horizontal m" id="form-settlement-edit" th:object="${busiSettlement}">
            <input name="settlementId" th:field="*{settlementId}" type="hidden">

            <div class="form-group">
                <label class="col-sm-3 control-label is-required">合同号：</label>
                <div class="col-sm-8">
                    <input name="contractNo" id="contractNo" th:field="*{contractNo}" class="form-control" type="text" readonly required >
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label is-required">报价单号：</label>
                <div class="col-sm-8">
                    <input name="quotationNo" id="quotationNo" th:field="*{quotationNo}"  class="form-control" type="text" readonly required>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">办事处：</label>
                <div class="col-sm-8">
                    <input name="officeAddress" id="officeAddress" th:field="*{officeAddress}" readonly class="form-control" type="text">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">业务员：</label>
                <div class="col-sm-8">
                    <input name="officeStaffName" id="officeStaffName" th:field="*{officeStaffName}" readonly class="form-control" type="text">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">合同金额/元：</label>
                <div class="col-sm-8">
                    <input name="contractPrice" id="contractPrice" class="form-control" th:field="*{contractPrice}" type="text" readonly>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">报价金额/元：</label>
                <div class="col-sm-8">
                    <input name="quotationPrice" id="quotationPrice" th:field="*{quotationPrice}" class="form-control" type="text" readonly>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">电机成本/元：</label>
                <div class="col-sm-8">
                    <input name="motorCost" id="motorCost" th:field="*{motorCost}"  class="form-control" type="text" readonly>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">特殊配置费用/元：</label>
                <div class="col-sm-8">
                    <input name="otherCost" id="otherCost" th:field="*{otherCost}" class="form-control" type="text" readonly>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">基础性提成计提比例/%：</label>
                <div class="col-sm-8">
                    <input name="basedCommission" id="basedCommission"  class="form-control" type="text" required>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">溢价部分计提比例/%：</label>
                <div class="col-sm-8">
                    <input name="premiumCommission" id="premiumCommission"   class="form-control" type="text" required>
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-3 control-label">应付业务费用类型选择：</label>
                <div class="col-sm-8">
                    <select  class="businessCommissionType form-control m-b" onchange="choseType()">
                        <option value="">请选择</option>
                        <option value="conventional">常规</option>
                        <option value="yiShiYiYi">一事一议</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-3 control-label">应付业务费合计/元：</label>
                <div class="col-sm-8">
                    <input name="businessCommission" id="businessCommission" class="form-control" type="text" readonly required>
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-3 control-label">质保金比例/%：</label>
                <div class="col-sm-8">
                    <input name="warrantyCommission" id="warrantyCommission" class="form-control" type="text" >
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">已回款金额/元：</label>
                <div class="col-sm-8">
                    <input name="receivedCommission" id="receivedCommission" class="form-control" type="text" >
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">已结算业务费：</label>
                <div class="col-sm-8">
                    <input th:value="${busiSettlement.settlementBusinessFee}" id="alreadySettlementBusinessFee" class="form-control" type="text" readonly>
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-3 control-label">本次结算业务费：</label>
                <div class="col-sm-8">
                    <input name="settlementBusinessFee" id="settlementBusinessFee"  class="form-control" type="text" readonly>
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-3 control-label">暂扣代缴个人所得税：</label>
                <div class="col-sm-8">
                    <input name="individualIncomeTax" id="individualIncomeTax" class="form-control" type="text" readonly>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">支付业务费金额：</label>
                <div class="col-sm-8">
                    <input name="amountOfBusiness" id="amountOfBusiness" class="form-control" type="text" readonly>
                </div>
            </div>
            <button   type="button"  class="btn-primary" onclick="calculate()">计算金额</button>
        </form>
    </div>
    <th:block th:include="include :: footer" />
    <script th:inline="javascript">
        var prefix = ctx + "busi/settlement";
        $("#form-settlement-edit").validate({
            focusCleanup: true
        });


        function choseType() {
            var businessCommissionType = $(".businessCommissionType").val()
            if (businessCommissionType == "conventional"){
                var basedCommission =  parseFloat($("#basedCommission").val());
                var premiumCommission =  parseFloat($("#premiumCommission").val());
                var contractPrice = parseFloat($("#contractPrice").val());
                var quotationPrice = parseFloat($("#quotationPrice").val());
                var motorCost = parseFloat($("#motorCost").val());
                var otherCost = parseFloat($("#otherCost").val());
                /*if (!isNaN(basedCommission) || !isNaN(premiumCommission)){
                    $.modal.alertWarning("“基础性提成计提比例”或“基础性提成计提比例”中请输入正确的数字");
                    return;
                }*/
                //(合同金额-电机成本*1.1-特殊配置费用*1.1)*基础性提成计提比例+(合同金额-报价金额)*溢价部分计提比例
                var  businessCommission = (contractPrice - motorCost - otherCost) *  (basedCommission / 100) + (contractPrice - quotationPrice) * (premiumCommission / 100)
                $("#businessCommission").val(businessCommission.toFixed(2));
                $("#businessCommission").attr("readonly","readonly")
            }else if(businessCommissionType = "yiShiYiYi"){
                $("#businessCommission").removeAttr("readonly");
            }
        }

        function calculate(){
            var basedCommission =  parseFloat($("#basedCommission").val());
            var contractPrice =       parseFloat($("#contractPrice").val());
            var receivedCommission =  parseFloat($("#receivedCommission").val());
            var businessCommission =  parseFloat($("#businessCommission").val());
            var warrantyCommission =  parseFloat($("#warrantyCommission").val());
            var alreadySettlementBusinessFee = parseFloat($("#alreadySettlementBusinessFee").val());
            var number  = (receivedCommission/contractPrice * (businessCommission - contractPrice * (warrantyCommission/100)) - alreadySettlementBusinessFee)
            $("#settlementBusinessFee").val(number.toFixed(2));
            //代缴个人税 = 结算业务费*20%
            $("#individualIncomeTax").val((number*0.2).toFixed(2));
            //支付业务费金额 = 结算业务费*80%
            $("#amountOfBusiness").val((number*0.8).toFixed(2))
        }

        function submitHandler() {
            if ($.validate.form()) {
                $.operate.save(prefix + "/edit", $('#form-settlement-edit').serialize());
            }
        }
    </script>
</body>
</html>
