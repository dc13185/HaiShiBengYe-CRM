<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
    <th:block th:include="include :: header('新增业务费用结算')" />
</head>
<body class="white-bg">
    <div class="wrapper wrapper-content animated fadeInRight ibox-content">
        <form class="form-horizontal m" id="form-settlement-add">
            <div class="form-group">
                <label class="col-sm-3 control-label is-required">合同号：</label>
                <div class="col-sm-8">
                    <div class="input-group">
                        <input name="contractNo" id="contractNo" class="form-control" type="text" readonly required  onclick="selectContractNo()">
                        <span class="input-group-addon"><i class="fa fa-search"></i></span>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label is-required">报价单号：</label>
                <div class="col-sm-8">
                    <input name="quotationNo" id="quotationNo" class="form-control" type="text" readonly required>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">办事处：</label>
                <div class="col-sm-8">
                    <input name="officeAddress" id="officeAddress" readonly class="form-control" type="text">
                    <input name="staffId" id="staffId" readonly class="form-control" type="hidden">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">业务员：</label>
                <div class="col-sm-8">
                    <input name="officeStaffName" id="officeStaffName" readonly class="form-control" type="text">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">合同金额/元：</label>
                <div class="col-sm-8">
                    <input name="contractPrice" id="contractPrice" class="form-control" type="text" readonly>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">报价金额/元：</label>
                <div class="col-sm-8">
                    <input name="quotationPrice" id="quotationPrice" class="form-control" type="text" readonly>
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-3 control-label">成本金额/元：</label>
                <div class="col-sm-8">
                    <input name="quotationCost" id="quotationCost" class="form-control" type="text" readonly>
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-3 control-label">电机成本/元：</label>
                <div class="col-sm-8">
                    <input name="motorCost" id="motorCost" class="form-control" type="text" readonly>
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-3 control-label">冲洗方案成本/元：</label>
                <div class="col-sm-8">
                    <input name="rinseCost" id="rinseCost" class="form-control" type="text" readonly>
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-3 control-label">特殊配置费用/元：</label>
                <div class="col-sm-8">
                    <input name="otherCost" id="otherCost" class="form-control" type="text" readonly>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">基础性提成计提比例/%：</label>
                <div class="col-sm-8">
                    <input name="basedCommission" id="basedCommission" class="form-control" type="text" required>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">溢价部分计提比例/%：</label>
                <div class="col-sm-8">
                    <input name="premiumCommission" id="premiumCommission" class="form-control" type="text" required>
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-3 control-label">应付业务费用类型选择：</label>
                <div class="col-sm-8">
                    <select  name="businessCommissionType" class="businessCommissionType form-control m-b" onchange="choseType()">
                        <option value="">请选择</option>
                        <option value="0">常规</option>
                        <option value="1">一事一议</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-3 control-label">应付业务费合计/元：</label>
                <div class="col-sm-8">
                    <input name="businessCommission" id="businessCommission" class="form-control" type="text" readonly required>
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-3 control-label">质保金比例/%：</label>
                <div class="col-sm-8">
                    <input name="warrantyCommission" id="warrantyCommission" class="form-control" type="text" >
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-3 control-label">质保金暂扣比例/%：</label>
                <div class="col-sm-8">
                    <input name="deductionCommission" id="deductionCommission" class="form-control" type="text" >
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-3 control-label">已回款金额/元：</label>
                <div class="col-sm-8">
                    <input name="receivedCommission" id="receivedCommission" class="form-control" type="text" >
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">结算业务费：</label>
                <div class="col-sm-8">
                    <input name="settlementBusinessFee" id="settlementBusinessFee" class="form-control" type="text" readonly>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">暂扣代缴个人所得税：</label>
                <div class="col-sm-8">
                    <input name="individualIncomeTax" id="individualIncomeTax" class="form-control" type="text" readonly>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">支付业务费金额：</label>
                <div class="col-sm-8">
                    <input name="amountOfBusiness" id="amountOfBusiness" class="form-control" type="text" readonly>
                </div>
            </div>
            <button   type="button"  class="btn-primary" onclick="calculate()">计算金额</button>
        </form>
    </div>
    <th:block th:include="include :: footer" />
    <script th:inline="javascript">
        var prefix = ctx + "busi/settlement"
        $("#form-settlement-add").validate({
            focusCleanup: true
        });

        function selectContractNo(){
            $.modal.open("选择合同", ctx + "busi/contract");
        }

        function choseType() {
            var businessCommissionType = $(".businessCommissionType").val()
            if (businessCommissionType == "0"){
                var basedCommission =  parseFloat($("#basedCommission").val());
                var premiumCommission =  parseFloat($("#premiumCommission").val());
                var contractPrice = parseFloat($("#contractPrice").val());
                var quotationCost = parseFloat($("#quotationCost").val());
                var motorCost = parseFloat($("#motorCost").val());
                var otherCost = parseFloat($("#otherCost").val());
                debugger;
                var rinseCost = parseFloat($("#rinseCost").val());
                /*if (!isNaN(basedCommission) || !isNaN(premiumCommission)){
                    $.modal.alertWarning("“基础性提成计提比例”或“基础性提成计提比例”中请输入正确的数字");
                    return;
                }*/
                //(合同金额-电机成本*1.1-特殊配置费用*1.1)*基础性提成计提比例+(合同金额-报价金额)*溢价部分计提比例
                var  businessCommission = 0;
                if ((contractPrice - quotationCost) > 0){
                    businessCommission =  (contractPrice - motorCost*1.1 - otherCost*1.1 - rinseCost*1.1) *  (basedCommission / 100) + (contractPrice - quotationCost) * (premiumCommission / 100)
                }else{
                    businessCommission = (contractPrice - motorCost*1.1 - otherCost*1.1  - rinseCost*1.1) *  (basedCommission / 100);
                }

                $("#businessCommission").val(businessCommission.toFixed(2));
                $("#businessCommission").attr("readonly","readonly")
            }else if(businessCommissionType = "1"){
                $("#businessCommission").removeAttr("readonly");
            }
        }

        function calculate(){
            var basedCommission =  parseFloat($("#basedCommission").val());
            var contractPrice =       parseFloat($("#contractPrice").val());
            var receivedCommission =  parseFloat($("#receivedCommission").val());
            var businessCommission =  parseFloat($("#businessCommission").val());
            var warrantyCommission =  parseFloat($("#warrantyCommission").val());
            var deductionCommission =  parseFloat($("#deductionCommission").val());
            //（回款金额/合同金额）*（应付业务费合计-合同金额*质保金比例*质保金暂扣比例）
            var number  = receivedCommission/contractPrice * (businessCommission - contractPrice * (warrantyCommission/100) * (deductionCommission/100))
            $("#settlementBusinessFee").val(number.toFixed(2));
            //代缴个人税 = 结算业务费*20%
            $("#individualIncomeTax").val((number*0.2).toFixed(2));
            //支付业务费金额 = 结算业务费*80%
            $("#amountOfBusiness").val((number*0.8).toFixed(2))
        }



        function submitHandler() {
            if ($.validate.form()) {
                $.operate.save(prefix + "/add", $('#form-settlement-add').serialize());
            }
        }
    </script>
</body>
</html>
